name: Test node-minify Action

on:
  push:
    branches: [feature/github-action]
    paths:
      - ".github/actions/node-minify/**"
      - ".github/workflows/test-action.yml"
  pull_request:
    paths:
      - ".github/actions/node-minify/**"
      - ".github/workflows/test-action.yml"
  workflow_dispatch:

jobs:
  test-js-minification:
    name: Test JS Minification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test file
        run: |
          mkdir -p test-action
          cat > test-action/input.js << 'EOF'
          function helloWorld() {
            const message = "Hello, World!";
            console.log(message);
            return message;
          }

          function unusedFunction() {
            return "This function is not used";
          }

          helloWorld();
          EOF

      - name: Minify with terser
        id: minify-terser
        uses: ./.github/actions/node-minify
        with:
          input: "test-action/input.js"
          output: "test-action/output.min.js"
          compressor: "terser"

      - name: Verify terser outputs
        run: |
          echo "Original size: ${{ steps.minify-terser.outputs.original-size-formatted }}"
          echo "Minified size: ${{ steps.minify-terser.outputs.minified-size-formatted }}"
          echo "Reduction: ${{ steps.minify-terser.outputs.reduction-percent }}%"
          echo "Gzip size: ${{ steps.minify-terser.outputs.gzip-size-formatted }}"
          echo "Time: ${{ steps.minify-terser.outputs.time-ms }}ms"
          
          if [ ! -f "test-action/output.min.js" ]; then
            echo "::error::Output file was not created"
            exit 1
          fi
          
          if [ "$(echo '${{ steps.minify-terser.outputs.reduction-percent }} > 0' | bc -l)" -ne 1 ]; then
            echo "::error::Reduction percentage should be > 0"
            exit 1
          fi
          
          echo "Output file content:"
          cat test-action/output.min.js

      - name: Minify with esbuild
        id: minify-esbuild
        uses: ./.github/actions/node-minify
        with:
          input: "test-action/input.js"
          output: "test-action/output.esbuild.js"
          compressor: "esbuild"
          type: "js"

      - name: Compare results
        run: |
          echo "## Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Compressor | Minified Size | Reduction |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|---------------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| terser | ${{ steps.minify-terser.outputs.minified-size-formatted }} | ${{ steps.minify-terser.outputs.reduction-percent }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| esbuild | ${{ steps.minify-esbuild.outputs.minified-size-formatted }} | ${{ steps.minify-esbuild.outputs.reduction-percent }}% |" >> $GITHUB_STEP_SUMMARY

  test-css-minification:
    name: Test CSS Minification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test CSS file
        run: |
          mkdir -p test-action
          cat > test-action/input.css << 'EOF'
          .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin: 10px;
          }

          .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
          }

          .button:hover {
            background-color: #0056b3;
          }
          EOF

      - name: Minify CSS with lightningcss
        id: minify-css
        uses: ./.github/actions/node-minify
        with:
          input: "test-action/input.css"
          output: "test-action/output.min.css"
          compressor: "lightningcss"
          type: "css"

      - name: Verify CSS output
        run: |
          echo "Original: ${{ steps.minify-css.outputs.original-size-formatted }}"
          echo "Minified: ${{ steps.minify-css.outputs.minified-size-formatted }}"
          echo "Reduction: ${{ steps.minify-css.outputs.reduction-percent }}%"
          
          if [ "$(echo '${{ steps.minify-css.outputs.reduction-percent }} > 0' | bc -l)" -ne 1 ]; then
            echo "::error::CSS reduction percentage should be > 0"
            exit 1
          fi
          
          cat test-action/output.min.css

  test-summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [test-js-minification, test-css-minification]
    steps:
      - name: All tests passed
        run: echo "âœ… All node-minify action tests passed!"
